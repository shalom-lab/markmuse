<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarkMuse æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
    }
    .test-section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.success {
      background: #4caf50;
      color: white;
    }
    .status.error {
      background: #f44336;
      color: white;
    }
    .status.pending {
      background: #ff9800;
      color: white;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .output {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      max-height: 400px;
      overflow: auto;
    }
    .output pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
      line-height: 1.5;
    }
    .preview {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .info code {
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 3px;
    }
    /* ç¡®ä¿å…¬å¼ SVG å¯è§ */
    .block-equation,
    .inline-equation {
      color: #333333;
    }
    .block-equation svg,
    .inline-equation svg {
      display: inline-block;
      vertical-align: middle;
      color: inherit;
      fill: currentColor;
      max-width: 100%;
      height: auto;
      min-width: 1px;
      min-height: 1px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MarkMuse æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•</h1>
    
    <div class="info">
      <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
      <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• <code>dist/bundle.iife.js</code> åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­çš„å…¼å®¹æ€§ã€‚</p>
      <p><strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯æ‰“åŒ…åçš„ IIFE bundle æ˜¯å¦èƒ½åœ¨æµè§ˆå™¨ä¸­æ­£å¸¸è¿è¡Œï¼Œæ‰€æœ‰ä¾èµ–éƒ½å·²æ‰“åŒ…ï¼Œæ²¡æœ‰ Node.js ç‰¹æœ‰çš„ä¾èµ–ã€‚</p>
      <p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>ç¡®ä¿å·²è¿è¡Œ <code>npm run build</code> æ„å»ºåº“æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹æµ‹è¯•æŒ‰é’®ã€‚</p>
    </div>

    <div class="test-section">
      <h2>
        æµ‹è¯• 1: æ¨¡å—åŠ è½½æµ‹è¯•
        <span class="status pending" id="loadStatus">å¾…æµ‹è¯•</span>
      </h2>
      <p>éªŒè¯èƒ½å¦æˆåŠŸåŠ è½½ <code>dist/bundle.iife.js</code> bundle</p>
      <button onclick="testModuleLoad()">å¼€å§‹æµ‹è¯•</button>
      <div class="output" id="loadOutput" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h2>
        æµ‹è¯• 2: è½¬æ¢åŠŸèƒ½æµ‹è¯•ï¼ˆé»˜è®¤æ ·å¼ï¼‰
        <span class="status pending" id="convertStatus">å¾…æµ‹è¯•</span>
      </h2>
      <p>éªŒè¯ <code>convertDefault</code> å‡½æ•°èƒ½å¦æ­£å¸¸å·¥ä½œ</p>
      <button onclick="testConvertDefault()" id="convertBtn" disabled>å¼€å§‹æµ‹è¯•</button>
      <button onclick="copyToWeChat('default')" id="copyDefaultBtn" disabled style="background: #4caf50;">ğŸ“‹ å¤åˆ¶åˆ°å…¬ä¼—å·</button>
      <div class="output" id="convertOutput" style="display: none;"></div>
      <div class="preview" id="convertPreview" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h2>
        æµ‹è¯• 3: è½¬æ¢åŠŸèƒ½æµ‹è¯•ï¼ˆè‡ªå®šä¹‰ CSSï¼‰
        <span class="status pending" id="customStatus">å¾…æµ‹è¯•</span>
      </h2>
      <p>éªŒè¯ <code>convert</code> å‡½æ•°èƒ½å¦æ­£å¸¸å·¥ä½œ</p>
      <button onclick="testConvertCustom()" id="customBtn" disabled>å¼€å§‹æµ‹è¯•</button>
      <button onclick="copyToWeChat('custom')" id="copyCustomBtn" disabled style="background: #4caf50;">ğŸ“‹ å¤åˆ¶åˆ°å…¬ä¼—å·</button>
      <div class="output" id="customOutput" style="display: none;"></div>
      <div class="preview" id="customPreview" style="display: none;"></div>
    </div>
  </div>

  <!-- åŠ è½½ MathJax -->
  <script>
    // é…ç½® MathJaxï¼šç”Ÿæˆå®Œæ•´çš„ pathï¼Œä¸ä½¿ç”¨ use å¼•ç”¨
    // è¿™æ ·å¯ä»¥é¿å…ç¬¦å·å®šä¹‰ä¸¢å¤±çš„é—®é¢˜
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']]
      },
      svg: {
        fontCache: 'none'  // å…³é”®ï¼šç”Ÿæˆå®Œæ•´çš„ pathï¼Œä¸ä½¿ç”¨ use å¼•ç”¨
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  
  <!-- åŠ è½½ bundle (IIFE æ ¼å¼ï¼Œä¼šæŒ‚è½½åˆ° window.MarkMuse) -->
  <script src="./dist/bundle.iife.js"></script>

  <script type="module">
    let convert, convertDefault;
    let moduleLoaded = false;
    let lastConvertedHtml = {
      default: null,
      custom: null
    };

    const testMarkdown = `
# æµ‹è¯•æ ‡é¢˜

è¿™æ˜¯åŒ…å«**æ•°å­¦å…¬å¼**çš„å†…å®¹ï¼š$E = mc^2$

å—çº§å…¬å¼ï¼š

$$
\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}
$$

\`\`\`javascript
console.log("Hello MarkMuse");
\`\`\`

> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨æµ‹è¯•
`;

    const customCss = `
#markmuse {
  background: #f0f0f0;
  padding: 20px;
}
#markmuse h1 {
  color: #ff6b6b;
}
`;

    // æµ‹è¯• 1: æ¨¡å—åŠ è½½
    window.testModuleLoad = async function() {
      const statusEl = document.getElementById('loadStatus');
      const outputEl = document.getElementById('loadOutput');
      
      statusEl.textContent = 'æµ‹è¯•ä¸­...';
      statusEl.className = 'status pending';
      outputEl.style.display = 'block';
      outputEl.innerHTML = '<pre>æ­£åœ¨åŠ è½½ bundle...</pre>';

      try {
        // bundle.iife.js ä¼šå°†å‡½æ•°æŒ‚è½½åˆ° window.MarkMuse
        if (typeof window.MarkMuse === 'object' && window.MarkMuse !== null) {
          convert = window.MarkMuse.convert;
          convertDefault = window.MarkMuse.convertDefault;

          if (typeof convert === 'function' && typeof convertDefault === 'function') {
            moduleLoaded = true;
            statusEl.textContent = 'âœ… é€šè¿‡';
            statusEl.className = 'status success';
            outputEl.innerHTML = '<pre>âœ… Bundle åŠ è½½æˆåŠŸï¼\n\nå¯¼å‡ºçš„å‡½æ•°ï¼š\n- convert: ' + typeof convert + '\n- convertDefault: ' + typeof convertDefault + '\n\nå‡½æ•°å·²æŒ‚è½½åˆ° window.MarkMuse</pre>';
            
            // å¯ç”¨å…¶ä»–æµ‹è¯•æŒ‰é’®
            document.getElementById('convertBtn').disabled = false;
            document.getElementById('customBtn').disabled = false;
          } else {
            throw new Error('å‡½æ•°æœªæ­£ç¡®å¯¼å‡ºåˆ° window.MarkMuse');
          }
        } else {
          throw new Error('window.MarkMuse æœªå®šä¹‰ï¼Œè¯·ç¡®ä¿ bundle.iife.js å·²æ­£ç¡®åŠ è½½');
        }
      } catch (error) {
        statusEl.textContent = 'âŒ å¤±è´¥';
        statusEl.className = 'status error';
        outputEl.innerHTML = '<pre>âŒ Bundle åŠ è½½å¤±è´¥ï¼š\n\n' + error.message + '\n\n' + (error.stack || '') + '\n\nè¯·ç¡®ä¿å·²è¿è¡Œ npm run build æ„å»º bundle.iife.js</pre>';
      }
    };

    // æµ‹è¯• 2: convertDefault
    window.testConvertDefault = async function() {
      if (!moduleLoaded) {
        alert('è¯·å…ˆå®Œæˆæ¨¡å—åŠ è½½æµ‹è¯•');
        return;
      }

      const statusEl = document.getElementById('convertStatus');
      const outputEl = document.getElementById('convertOutput');
      const previewEl = document.getElementById('convertPreview');
      
      statusEl.textContent = 'æµ‹è¯•ä¸­...';
      statusEl.className = 'status pending';
      outputEl.style.display = 'block';
      outputEl.innerHTML = '<pre>æ­£åœ¨è½¬æ¢...</pre>';

      try {
        // ç­‰å¾… MathJax åŠ è½½
        await new Promise((resolve) => {
          if (window.MathJax && typeof window.MathJax.tex2svg === 'function') {
            resolve();
          } else {
            const check = setInterval(() => {
              if (window.MathJax && typeof window.MathJax.tex2svg === 'function') {
                clearInterval(check);
                resolve();
              }
            }, 100);
            setTimeout(() => {
              clearInterval(check);
              resolve();
            }, 5000);
          }
        });

        const html = await convertDefault(testMarkdown);
        
        // ä¿å­˜è½¬æ¢ç»“æœï¼Œä¾›å¤åˆ¶åŠŸèƒ½ä½¿ç”¨
        lastConvertedHtml.default = html;
        
        statusEl.textContent = 'âœ… é€šè¿‡';
        statusEl.className = 'status success';
        outputEl.innerHTML = '<pre>' + escapeHtml(html.substring(0, 500)) + '...\n\n(å®Œæ•´ HTML å·²æ˜¾ç¤ºåœ¨ä¸‹æ–¹é¢„è§ˆåŒºåŸŸ)</pre>';
        previewEl.style.display = 'block';
        previewEl.innerHTML = html;
        
        // å¯ç”¨å¤åˆ¶æŒ‰é’®
        document.getElementById('copyDefaultBtn').disabled = false;
      } catch (error) {
        statusEl.textContent = 'âŒ å¤±è´¥';
        statusEl.className = 'status error';
        outputEl.innerHTML = '<pre>âŒ è½¬æ¢å¤±è´¥ï¼š\n\n' + error.message + '\n\n' + error.stack + '</pre>';
      }
    };

    // æµ‹è¯• 3: convert (è‡ªå®šä¹‰ CSS)
    window.testConvertCustom = async function() {
      if (!moduleLoaded) {
        alert('è¯·å…ˆå®Œæˆæ¨¡å—åŠ è½½æµ‹è¯•');
        return;
      }

      const statusEl = document.getElementById('customStatus');
      const outputEl = document.getElementById('customOutput');
      const previewEl = document.getElementById('customPreview');
      
      statusEl.textContent = 'æµ‹è¯•ä¸­...';
      statusEl.className = 'status pending';
      outputEl.style.display = 'block';
      outputEl.innerHTML = '<pre>æ­£åœ¨è½¬æ¢...</pre>';

      try {
        // ç­‰å¾… MathJax åŠ è½½
        await new Promise((resolve) => {
          if (window.MathJax && typeof window.MathJax.tex2svg === 'function') {
            resolve();
          } else {
            const check = setInterval(() => {
              if (window.MathJax && typeof window.MathJax.tex2svg === 'function') {
                clearInterval(check);
                resolve();
              }
            }, 100);
            setTimeout(() => {
              clearInterval(check);
              resolve();
            }, 5000);
          }
        });

        const html = await convert(testMarkdown, customCss);
        
        // ä¿å­˜è½¬æ¢ç»“æœï¼Œä¾›å¤åˆ¶åŠŸèƒ½ä½¿ç”¨
        lastConvertedHtml.custom = html;
        
        statusEl.textContent = 'âœ… é€šè¿‡';
        statusEl.className = 'status success';
        outputEl.innerHTML = '<pre>' + escapeHtml(html.substring(0, 500)) + '...\n\n(å®Œæ•´ HTML å·²æ˜¾ç¤ºåœ¨ä¸‹æ–¹é¢„è§ˆåŒºåŸŸ)</pre>';
        previewEl.style.display = 'block';
        previewEl.innerHTML = html;
        
        // å¯ç”¨å¤åˆ¶æŒ‰é’®
        document.getElementById('copyCustomBtn').disabled = false;
      } catch (error) {
        statusEl.textContent = 'âŒ å¤±è´¥';
        statusEl.className = 'status error';
        outputEl.innerHTML = '<pre>âŒ è½¬æ¢å¤±è´¥ï¼š\n\n' + error.message + '\n\n' + error.stack + '</pre>';
      }
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å¤åˆ¶åˆ°å…¬ä¼—å·åŠŸèƒ½ï¼ˆå‚è€ƒä¸»é¡¹ç›®çš„ copyToClipboard å®ç°ï¼‰
    window.copyToWeChat = async function(type) {
      const html = lastConvertedHtml[type];
      if (!html) {
        alert('è¯·å…ˆå®Œæˆè½¬æ¢æµ‹è¯•');
        return;
      }

      try {
        // ä» HTML ä¸­æå–çº¯æ–‡æœ¬
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const plainText = tempDiv.innerText || tempDiv.textContent || '';

        // ä½¿ç”¨ copySafari æ–¹æ³•ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬å’Œå¤šæ ¼å¼ï¼‰
        const success = await copySafari(html, plainText, testMarkdown);

        if (success) {
          alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nç°åœ¨å¯ä»¥ç²˜è´´åˆ°å¾®ä¿¡å…¬ä¼—å·ç¼–è¾‘å™¨ä¸­äº†ã€‚\n\næç¤ºï¼šåœ¨å…¬ä¼—å·ç¼–è¾‘å™¨ä¸­ï¼Œå…¬å¼åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚');
        } else {
          alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (error) {
        console.error('å¤åˆ¶å¤±è´¥:', error);
        alert('âŒ å¤åˆ¶å¤±è´¥ï¼š' + error.message);
      }
    };

    // å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆå‚è€ƒä¸»é¡¹ç›®çš„ copySafari å®ç°ï¼‰
    function copySafari(html, plainText, markdown) {
      return new Promise((resolve) => {
        let resolved = false;
        
        // è·å–æˆ–åˆ›å»º input å…ƒç´ 
        let input = document.getElementById('copy-input');
        if (!input) {
          input = document.createElement('input');
          input.id = 'copy-input';
          input.style.position = 'absolute';
          input.style.left = '-1000px';
          input.style.zIndex = '-1000';
          document.body.appendChild(input);
        }
        
        // è®© input é€‰ä¸­ä¸€ä¸ªå­—ç¬¦
        input.value = 'NOTHING';
        input.setSelectionRange(0, 1);
        input.focus();
        
        // å¤åˆ¶è§¦å‘
        const copyHandler = (e) => {
          e.preventDefault();
          if (e.clipboardData) {
            e.clipboardData.setData('text/html', html);
            e.clipboardData.setData('text/plain', plainText || html);
            if (markdown) {
              e.clipboardData.setData('text/markdown', markdown);
            }
          }
          document.removeEventListener('copy', copyHandler);
          if (!resolved) {
            resolved = true;
            resolve(true);
          }
        };
        
        document.addEventListener('copy', copyHandler);
        
        try {
          const success = document.execCommand('copy');
          if (!success && !resolved) {
            setTimeout(() => {
              if (navigator.clipboard && !resolved) {
                const textArea = document.createElement('textarea');
                textArea.value = html;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                  document.execCommand('copy');
                  document.body.removeChild(textArea);
                  if (!resolved) {
                    resolved = true;
                    resolve(true);
                  }
                } catch (err) {
                  document.body.removeChild(textArea);
                  if (!resolved) {
                    resolved = true;
                    resolve(false);
                  }
                }
              } else if (!resolved) {
                resolved = true;
                resolve(false);
              }
            }, 100);
          }
        } catch (err) {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          if (!resolved) {
            resolved = true;
            resolve(false);
          }
        }
      });
    }
  </script>
</body>
</html>

