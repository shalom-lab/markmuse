# MarkMuse 同步模式说明（OPFS + GitHub）

## 1. 本地与远程的存储结构

- **本地（浏览器 OPFS）**
  - 根目录固定为：`markmuse/`
  - 参与同步的文件：
    - 任意子路径下的 `*.md`（笔记文件）
      - 例：`foo/bar/note.md`
    - `.themes/{id}.css`（主题文件）
      - 例：`.themes/default.css`、`.themes/wechat-simple.css`

- **远程（GitHub 仓库）**
  - 所有同步内容都放在：`{basePath}/.markmuse/` 目录下，其中 `{basePath}` 来自设置页的「同步路径」（留空则为仓库根目录）。
  - 笔记文件映射：
    - 本地：`foo/bar/note.md`
    - 远程：`{basePath}/.markmuse/files/foo/bar/note.md`
  - 主题文件映射：
    - 本地：`.themes/default.css`
    - 远程：`{basePath}/.markmuse/.themes/default.css`

> 约定：`*.md` 与 `.themes/*.css` 使用**完全相同**的同步规则，不再为 CSS 设计特殊分支，避免行为不一致。

---

## 2. 三种操作模式（都在设置页触发）

### 2.1 普通同步（“立即同步”按钮）

**语义：本地 → 远程，增量推送，只处理新增/修改，不删除远程，也不从远程拉取。**

- 遍历本地 OPFS：
  - 所有 `*.md`
  - 所有 `.themes/*.css`
- 对每个本地文件 `path`：
  - 如果远程不存在对应文件：
    - 在远程创建新文件：
      - 笔记：写入到 `.markmuse/files/{path}`
      - 主题：写入到 `.markmuse/.themes/{id}.css`
  - 如果远程已存在：
    - 直接用本地内容覆盖远程内容（`Update`），不比较时间戳，只以当前本地为准。
- 对于“远程有、本地没有”的文件：
  - **不做任何操作**，远程文件保留。
- 不会发生的操作：
  - 不会删除任何远程文件；
  - 不会从远程拉取新文件；
  - 不会用远程内容覆盖本地文件。

> 心智模型：GitHub 用作「备份/中转仓」，平时只是一股脑把当前本地状态推过去，本地误删不会影响远程。

---

### 2.2 从远程拉取（覆盖本地）

**语义：远程 → 本地，强制用远程 `.markmuse` 覆盖本地 OPFS 中的所有 MarkMuse 数据。**

- 触发：用户在设置页点击「从远程拉取（覆盖本地）」并二次确认。
- 行为：
  1. 在远程列出 `{basePath}/.markmuse/**` 下所有文件：
     - `.markmuse/files/**.md`
     - `.markmuse/.themes/**.css`
  2. 本地清理（仅限 MarkMuse 相关）：
     - 删除 OPFS 中所有 `*.md`
     - 删除 OPFS 中所有 `.themes/*.css`
  3. 对每个远程文件进行映射写回本地：
     - `.markmuse/files/foo/bar/note.md` → 写到本地 `foo/bar/note.md`
     - `.markmuse/.themes/default.css` → 写到本地 `.themes/default.css`
  4. 重建本地同步基线（如果使用 SHA 基线机制），确保后续普通同步可以继续工作。

- 结果：
  - 本地所有笔记与主题被远程内容**完全覆盖**；
  - 本地之前尚未推送的修改将丢失（由用户在确认弹窗中承担这一决策）。

> 心智模型：把远程 `.markmuse` 当成真相源，在当前设备上「恢复」到远程版本。

---

### 2.3 推到远程（覆盖远程）

**语义：本地 → 远程，强制用当前本地 OPFS 状态覆盖远程 `.markmuse` 整个子树。**

- 触发：用户在设置页点击「推到远程（覆盖远程）」并二次确认。
- 行为：
  1. 在远程列出 `{basePath}/.markmuse/**` 所有文件，并全部删除（仅影响 `.markmuse` 目录）。
  2. 遍历本地 OPFS：
     - 所有 `*.md` → 上传为 `.markmuse/files/{path}`
     - 所有 `.themes/*.css` → 上传为 `.markmuse/.themes/{id}.css`
  3. 重建远程后的同步基线（如果启用基线机制）。

- 结果：
  - 仓库中 `.markmuse` 目录的内容将与当前本地 OPFS 完全一致；
  - 远程之前的 MarkMuse 数据（包括其它设备写入的内容）会被当前这台机器覆盖（仅在 Git 历史中可追溯）。

> 心智模型：把当前设备当成「权威本地」，用它来统一远程状态，然后其它设备通过“从远程拉取”跟进。

---

## 3. 删除行为一览

- 本地删除文件：
  - 普通同步：**不会删除远程**，远程旧数据继续保留。
  - 从远程拉取：无关（反向覆盖本地）。
  - 推到远程：由于会清空并重建 `.markmuse`，本地没有的文件在覆盖后，远程也不会再有。

- 远程删除文件：
  - 普通同步：不会影响本地（不会主动拉取）。
  - 从远程拉取：本地会被远程当前状态覆盖，因此会一起反映远程删除。
  - 推到远程：由于以本地为准，只要本地还有，就会再次推回远程。

---

## 4. 使用建议

1. 日常只使用「立即同步」按钮：
   - 适合单机或你清楚当前设备就是主编辑端的情况；
   - 不用担心误删远程数据。

2. 多设备协作时：
   - 选定一台机器为「权威本地」：
     - 在那台机器上使用「推到远程（覆盖远程）」统一远程状态。
   - 其它设备：
     - 先用「从远程拉取（覆盖本地）」对齐；
     - 之后日常也只用普通同步。

3. `*.md` 和 `.themes/*.css` **永远遵守同一套规则**，不为 CSS 特例化，避免记混。


